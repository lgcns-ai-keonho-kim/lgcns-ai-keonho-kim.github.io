# 03. 메타데이터 스트리밍

## 이 챕터에서 배우는 것

- 메타데이터 스트리밍의 목적과 최소 이벤트
- 노드/라우팅/폴백 상태를 전달하는 방법
- 워커 실행 단계 메타데이터 설계
- 클라이언트 UI와 운영 관측에 필요한 필드
- LangGraph 이벤트에서 노드 이름을 추출하는 방법

---

## 1. 메타데이터 스트리밍이 필요한 이유

토큰만 전달하면 **왜 지연이 발생하는지, 어느 단계인지** 알 수 없습니다.
메타데이터는 다음에 사용됩니다.

- **진행 표시**: 노드 시작/완료, 분기 경로 표시
- **사용자 신뢰**: 폴백 발생 이유 안내
- **운영 관측**: 지연/실패 구간 추적

---

## 2. 이벤트 종류(권장)

- **node_start**: 노드 실행 시작
- **node_end**: 노드 실행 완료
- **route_decision**: 라우팅 결과
- **fallback**: 폴백 발생 및 사유
- **warning**: 지연/품질 경고
- **job_queued**: 작업이 큐에 적재됨
- **job_start**: 워커가 작업 실행 시작
- **job_end**: 워커가 작업 실행 완료
- **job_error**: 워커 실행 실패

---

## 3. 워커 실행 단계 메타데이터

비동기 실행 환경에서는 **워커 단계의 이벤트**가 중요합니다.
사용자는 “현재 대기 중인지, 실행 중인지”를 알 수 있어야 합니다.

- `job_queued`: API가 작업을 큐에 넣은 시점
- `job_start`: 워커가 작업을 가져간 시점
- `job_end`: 워커가 종료한 시점

이 이벤트는 **대기 지연 분석**에 큰 도움이 됩니다.

```python
"""
목적: 워커 단계 메타데이터를 예시로 보여준다.
설명: 큐 적재/실행 시작/완료 이벤트를 기록한다.
디자인 패턴: Value Object
"""

job_events = [
    {"event": "job_queued", "message": "작업이 큐에 적재됨"},
    {"event": "job_start", "message": "워커 실행 시작"},
    {"event": "job_end", "message": "워커 실행 완료"},
]
```

---

## 4. 최소 스키마 설계

```python
"""
목적: 메타데이터 이벤트 구조를 예시로 보여준다.
설명: 최소 필드만 포함한 딕셔너리 형태로 구성한다.
디자인 패턴: Value Object
"""

metadata_event = {
    "event": "node_start",
    "node": "retrieve",
    "message": "노드 실행 시작",
    "trace_id": "t-123",
    "timestamp": "2026-01-27T10:00:00Z",
    "route": None,
    "error_code": None,
}
```

---

## 5. 메타데이터 생성 예시

```python
"""
목적: 메타데이터 이벤트를 간단하게 생성한다.
설명: 필요한 정보만 받아서 딕셔너리로 만든다.
디자인 패턴: Factory
"""

from datetime import datetime


def make_metadata(event: str, node: str, trace_id: str, message: str, route: str | None = None, error_code: str | None = None) -> dict:
    return {
        "event": event,
        "node": node,
        "message": message,
        "trace_id": trace_id,
        "timestamp": datetime.utcnow().isoformat(),
        "route": route,
        "error_code": error_code,
    }
```

---

## 6. LangGraph 연결 포인트(개념)

- 노드 시작/종료 시점에 메타데이터 이벤트 발행
- 라우터 노드에서 경로 결정 이벤트 발행
- 폴백 노드 진입 시 에러 코드 포함
- 그래프 실행 종료 시 `done` 이벤트를 명시적으로 적재

```python
"""
목적: LangGraph 실행 중 메타데이터를 발행한다.
설명: 노드 실행 전/후에 메타데이터를 큐에 적재한다.
디자인 패턴: Observer
"""

def emit_metadata(event: dict) -> None:
    """메타데이터 이벤트를 큐에 적재한다."""
    enqueue_event(event)
```

---

## 7. LangGraph 이벤트에서 노드 이름 추출

LangGraph 이벤트 객체의 필드는 **버전에 따라 다를 수 있으므로**
노드 이름을 여러 키에서 탐색하는 방식이 안전합니다.

```python
"""
목적: 이벤트에서 노드 이름을 안정적으로 추출한다.
설명: 다양한 키(name/node/metadata)를 순차적으로 확인한다.
디자인 패턴: Adapter
"""

def extract_node_name(event: dict) -> str | None:
    """노드 이름을 추출한다."""
    if "node" in event:
        return event["node"]
    if "name" in event:
        return event["name"]
    metadata = event.get("metadata", {})
    return metadata.get("node") or metadata.get("name")
```

---

## 8. 실전 사용 시나리오

- **병렬 노드 진행 표시**: 각 노드 시작/종료를 UI에 표시
- **폴백 투명성 강화**: 폴백 사유를 사용자에게 명시
- **운영 대시보드**: node_end 기준으로 평균 지연 계산

---

## 9. 구현 체크리스트

- 메타데이터 이벤트 타입이 정의되어 있는가?
- `node/trace_id/timestamp`가 포함되는가?
- 폴백/라우팅 이벤트가 기록되는가?
- UI와 운영 모두에 활용 가능한 구조인가?
- 종료 신호(`done`)가 워커에서 명시적으로 적재되는가?
